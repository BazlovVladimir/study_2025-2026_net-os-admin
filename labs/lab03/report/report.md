---
## Front matter
title: "Отчёт по лабораторной работе №3"
subtitle: "Настройка DHCP-сервера"
author: "Владимир Базлов"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true
toc-depth: 2
lof: true
lot: true
fontsize: 12pt
linestretch: 1.5
papersize: a4
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
    - spelling=modern
    - babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float}
  - \floatplacement{figure}{H}
---

# Цель работы

Приобретение практических навыков по установке и конфигурированию DHCP-сервера.

# Выполнение

## Конфигурирование DHCP-сервера KEA и интеграция с DNS

### Сохранение конфигурационного файла

Был создан резервный вариант файла конфигурации DHCP-сервера перед внесением изменений.

### Редактирование файла `/etc/kea/kea-dhcp4.conf`

В конфигурацию внесены правки параметров домена. Блоки с example.org и srv.world заменены на значения, соответствующие домену vabazlov.net.  

Также изменён блок с DNS-серверами: вместо тестовых адресов использован адрес локального DNS-сервера 192.168.1.1.

Фрагмент изменённой конфигурации:

![Редактирование kea-dhcp4.conf](Screenshot_1.png){ #fig:001 width=80% }

### Описание подсети

Для DHCP-сети задана собственная конфигурация подсети 192.168.1.0/24, включающая диапазон выдачи адресов, шлюз и необходимые опции. Примеры других подсетей были удалены.

![Конфигурирование подсети](Screenshot_2.png){ #fig:002 width=80% }

### Привязка к интерфейсу eth1

Настроено использование интерфейса eth1 для работы DHCP-сервера. Конфигурационный файл прошёл проверку, ошибок не обнаружено.

![Проверка конфигурации](Screenshot_3.png){ #fig:003 width=80% }

### Включение DHCP-сервера и обновление systemd

DHCP-служба добавлена в автозагрузку и зарегистрирована в systemd.

![Перезагрузка systemd](Screenshot_3.png){ #fig:004 width=80% }

### Изменение DNS-зон

#### Прямая зона

В файл прямой зоны добавлена запись для имени dhcp.vabazlov.net. Серийный номер зоны обновлён.

![Прямая зона vabazlov.net](Screenshot_4.png){ #fig:005 width=80% }

#### Обратная зона

В конец файла обратной зоны добавлена PTR-запись, указывающая на dhcp.vabazlov.net. Также обновлён серийный номер зоны.

![Обратная зона 192.168.1](Screenshot_5.png){ #fig:006 width=80% }

### Перезапуск DNS-сервера и проверка имени

DNS-служба была перезапущена. Проверка имени dhcp.vabazlov.net прошла успешно.

![Проверка имени dhcp.vabazlov.net](Screenshot_6.png){ #fig:007 width=80% }

### Настройка межсетевого экрана и SELinux

Разрешена работа DHCP в firewall, обновлены SELinux-контексты каталогов, связанных с DHCP и DNS.

![Восстановление контекстов](Screenshot_7.png){ #fig:008 width=80% }

### Запуск DHCP-сервера и мониторинг

Был запущен мониторинг системных сообщений и стартовал DHCP-сервер. Ошибок при запуске не возникло.

## Анализ работы DHCP-сервера на клиенте

### Конфигурация клиента

После применения provisioning-скрипта виртуальная машина client была запущена. DHCP-сервер выдал ей адрес из заданного диапазона. Интерфейс eth1 получил корректные сетевые настройки.

![ifconfig клиента](Screenshot_8.png){ #fig:009 width=80% }

**Разбор интерфейсов:**

*eth1*  
- назначенный адрес: 192.168.1.30  
- маска подсети: 255.255.255.0  
- broadcast-адрес: 192.168.1.255  
- MAC-адрес интерфейса соответствует данным в DHCP  
- интерфейс активен, работают приём и передача пакетов  

*lo*  
- интерфейс обратной связи  
- параметры нормальные, без ошибок  

### Анализ выданных аренд DHCP

На сервере в файле со списком назначенных адресов отображаются актуальные данные о клиенте.

![Файл kea-leases4.csv](Screenshot_9.png){ #fig:010 width=80% }

**Построчный разбор содержимого:**

- **address** — выданный клиенту IP-адрес  
- **hwaddr** — MAC-адрес сетевого интерфейса клиента  
- **client_id** — уникальный идентификатор DHCP-клиента  
- **valid_lifetime** — срок действия аренды  
- **expire** — момент времени, когда аренда будет считаться просроченной  
- **subnet_id** — ID подсети из конфигурации DHCP-сервера  
- **fqdn_fwd / fqdn_rev** — включённые режимы обновления DNS  
- **hostname** — имя клиента, если передано  
- **state** — состояние аренды  
- **pool_id** — номер пула, из которого выделен адрес  

Файл подтверждает корректную работу DHCP и успешную выдачу IP-адреса клиенту.

## Настройка обновления DNS-зоны

### Создание и подключение TSIG-ключа для Bind9

На сервере с Bind9 был создан каталог для ключей и сгенерирован TSIG-ключ DHCP_UPDATER, после чего корректно настроены права доступа на каталог:

![Создание TSIG-ключа и права доступа](Screenshot_10.png){ #fig:011 width=80% }

Полученный ключ был подключён в конфигурации DNS-сервера.  
В файле `/etc/named.conf` добавлено подключение ключа, а в описаниях зон разрешено динамическое обновление:

- для прямой зоны `vabazlov.net` указан файл зоны и политика обновления с использованием ключа `DHCP_UPDATER` для A-записей;
- для обратной зоны `1.168.192.in-addr.arpa` настроено обновление PTR-записей с тем же ключом.

![Разрешение обновления зон в named.conf](Screenshot_11.png){ #fig:012 width=80% }

Конфигурация DNS была успешно проверена и DNS-сервер перезапущен без ошибок.

### Подготовка ключа для Kea

Для Kea создан файл `/etc/kea/tsig-keys.json`, в который ключ DHCP_UPDATER был перенесён в формате JSON: указаны имя ключа, алгоритм `hmac-sha512` и секрет.

![Файл tsig-keys.json](Screenshot_12.png){ #fig:013 width=80% }

Далее были настроены владелец и права доступа, чтобы к файлу мог обращаться только пользователь Kea и соответствующая группа.

### Конфигурация Kea DHCP-DDNS

В файле `/etc/kea/kea-dhcp-ddns.conf` была выполнена настройка службы динамического обновления DNS:

- указаны IP-адрес и порт, на которых слушает сервис DDNS;
- настроен управляющий сокет;
- подключён файл с TSIG-ключами `tsig-keys.json`;
- в секции `forward-ddns` задана зона `vabazlov.net.` с указанием ключа `DHCP_UPDATER` и DNS-сервера 192.168.1.1;
- в секции `reverse-ddns` аналогично настроена обратная зона `1.168.192.in-addr.arpa.`.

Особое внимание уделено точке в конце имён зон.

![Настройка kea-dhcp-ddns.conf](Screenshot_13.png){ #fig:014 width=80% }

После изменения владельца файла конфигурация была успешно проверена утилитой проверки, а служба `kea-dhcp-ddns` включена и запущена.  

Проверка статуса показала, что сервис активен и работает корректно:

![Проверка и запуск kea-dhcp-ddns](Screenshot_14.png){ #fig:015 width=80% }

### Разрешение обновления DNS из Kea DHCP-сервера

В файле `/etc/kea/kea-dhcp4.conf` был включён функционал динамического обновления DNS:

- разрешено обновление DNS-записей через блок `"dhcp-ddns": { "enable-updates": true }`;
- задан суффикс доменного имени `vabazlov.net`;
- включён параметр `ddns-override-client-update`, позволяющий серверу DHCP принудительно управлять обновлениями DNS.

![Изменения в kea-dhcp4.conf](Screenshot_15.png){ #fig:016 width=80% }

Конфигурация DHCP была успешно проверена, после чего служба `kea-dhcp4.service` перезапущена. Статус сервиса показывает, что DHCP-сервер запущен и функционирует нормально:

![Перезапуск и статус kea-dhcp4.service](Screenshot_16.png){ #fig:017 width=80% }

### Проверка динамического обновления зоны

На клиентской машине был переполучен адрес, в результате чего DHCP-сервер снова выдал клиенту IP-адрес и выполнил обновление записей в DNS.  

На сервере в каталоге прямой DNS-зоны `/var/named/master/fz` появился файл журнала зоны `vabazlov.net.jnl`, подтверждающий, что изменения в зону теперь вносятся динамически:

![Появление файла журнала зоны vabazlov.net.jnl](Screenshot_17.png){ #fig:018 width=80% }

Тем самым настройка динамического обновления DNS-зоны при появлении новых узлов в виртуальной внутренней сети завершена успешно.

## Анализ работы DHCP-сервера после настройки обновления DNS-зоны

На виртуальной машине client была выполнена команда запросы записи `A` для имени `client.vabazlov.net` с использованием DNS-сервера 192.168.1.1.

Результат:

![Результат dig на клиенте](Screenshot_18.png){ #fig:019 width=80% }

Постатейный разбор вывода:

- **DiG 9.18.33** — версия используемой утилиты dig.
- **@192.168.1.1 client.vabazlov.net** — выполнен запрос к DNS-серверу 192.168.1.1 о записи `A` для домена client.vabazlov.net.
- **Got answer** — ответ от сервера получен успешно.
- **status: NOERROR** — ошибок нет, доменное имя найдено.
- **flags: qr aa rd ra**  
  - *qr* — это ответ, а не запрос  
  - *aa* — сервер является авторитетным для зоны  
  - *rd/ra* — сервер поддерживает рекурсивные запросы  
- **QUESTION SECTION** — dig спрашивает запись `A` для client.vabazlov.net.
- **ANSWER SECTION** — DNS-сервер отвечает:
  - `client.vabazlov.net. 1200 IN A 192.168.1.30`  
    Это означает, что DHCP-сервер динамически создал A-запись для клиента с IP-адресом 192.168.1.30.
- **Query time: 1 msec** — запрос обработан очень быстро.
- **SERVER: 192.168.1.1#53** — DNS-сервер, который дал ответ.
- **WHEN:** — дата и время запроса.
- **MSG SIZE rcvd: 92** — размер DNS-ответа.

Это подтверждает, что механизм DDNS работает корректно: DHCP выдал адрес клиенту и автоматически создал соответствующую запись в DNS.

## Внесение изменений в настройки внутреннего окружения виртуальной машины

### Копирование конфигураций DHCP-сервера

В каталоге `/vagrant/provision/server/` был создан подкаталог для хранения конфигураций DHCP-сервера. В него помещены все файлы из `/etc/kea/`:

![Копирование конфигурации Kea](Screenshot_19.png){ #fig:020 width=80% }

Это позволяет Vagrant при следующем запуске автоматически применять корректные настройки DHCP-сервера.

### Копирование конфигураций DNS-сервера

В каталоге `/vagrant/provision/server/dns/` заменены:

- каталог `/var/named/`, содержащий файлы зон и журналы,
- каталог `/etc/named/`, содержащий конфигурацию Bind9.

Файлы были успешно скопированы, что гарантирует перенос всех настроек DDNS.

### Создание provisioning-скрипта dhcp.sh

В каталоге `/vagrant/provision/server/` создан исполняемый файл `dhcp.sh`, предназначенный для автоматизации настройки DHCP-сервера при развёртывании виртуалки.

Содержание скрипта:

![Скрипт dhcp.sh](Screenshot_20.png){ #fig:021 width=80% }

Скрипт выполняет следующие действия:

1. Устанавливает необходимые пакеты.
2. Копирует конфигурационные файлы DHCP.
3. Исправляет права доступа на каталоги и ключи.
4. Восстанавливает SELinux-контексты.
5. Открывает доступ к DHCP-службе в firewall.
6. Перезапускает systemd и включает службы:
   - `kea-dhcp4.service`
   - `kea-dhcp-ddns.service`

Благодаря этому DHCP-сервер и DDNS автоматически конфигурируются при каждом создании виртуальной машины.

# Контрольные вопросы

1. **В каких файлах хранятся настройки сетевых подключений?**  
   В Linux настройки сетевых подключений обычно находятся в каталоге `/etc/sysconfig/network-scripts/` (RedHat-based дистрибутивы, такие как Rocky Linux).  
   Каждый интерфейс имеет свой файл вида:  
   - `ifcfg-eth0`  
   - `ifcfg-eth1`  
   В них прописываются IP-адрес, маска, шлюз, DNS, режим работы интерфейса (static/DHCP) и другие параметры.  
   В системах с NetworkManager дополнительные настройки могут находиться в каталоге:  
   - `/etc/NetworkManager/system-connections/`.

2. **За что отвечает протокол DHCP?**  
   DHCP — это протокол динамической конфигурации узлов в сети. Он автоматически выдаёт клиентам IP-адреса, маску, шлюз, адреса DNS-серверов и другие параметры.  
   Благодаря DHCP устройства могут получать сетевые настройки без ручного ввода.

3. **Поясните принцип работы протокола DHCP. Какими сообщениями обмениваются клиент и сервер?**  
   DHCP работает по схеме *клиент–сервер*, используя четырёхэтапный обмен сообщениями:  
   - **DHCPDISCOVER** — клиент ищет DHCP-сервер.  
   - **DHCPOFFER** — сервер предлагает доступный IP-адрес.  
   - **DHCPREQUEST** — клиент подтверждает выбор и запрашивает параметры.  
   - **DHCPACK** — сервер подтверждает выдачу адреса и отправляет настройки.  
   В дополнение могут использоваться сообщения:  
   - **DHCPNAK** — отказ в выдаче адреса,  
   - **DHCPRELEASE** — клиент освобождает IP-адрес,  
   - **DHCPINFORM** — запрос параметров при статически заданном IP.

4. **В каких файлах обычно находятся настройки DHCP-сервера? За что отвечает каждый из файлов?**  
   В KEA DHCP настройки хранятся в каталоге `/etc/kea/`:  
   - **kea-dhcp4.conf** — основной конфигурационный файл DHCPv4: подсети, пулы адресов, опции, интерфейсы.  
   - **kea-dhcp-ddns.conf** — настройки DDNS (динамическое обновление DNS-зон).  
   - **tsig-keys.json** — ключи TSIG для защиты DDNS-обмена.  
   - ***.lease files / kea-leases4.csv** — база данных выданных адресов (leases).  
   Эти файлы определяют структуру сети, безопасность и взаимодействие Kea с DNS.

5. **Что такое DDNS? Для чего применяется DDNS?**  
   DDNS (Dynamic DNS) — механизм автоматического обновления DNS-записей при изменении сетевых параметров узлов.  
   Он используется для:  
   - автоматического создания и удаления A- и PTR-записей,  
   - синхронизации DNS с DHCP,  
   - упрощения управления сетями с часто меняющимися адресами,  
   - корректной работы имён хостов в динамических сетях.  
   DDNS активно применяется с DHCP, где узлы получают временные IP-адреса.

6. **Какую информацию можно получить с помощью утилиты ifconfig? Приведите примеры.**  
   `ifconfig` выводит сведения о сетевых интерфейсах:  
   - IP-адрес и маску,  
   - MAC-адрес,  
   - статус интерфейса (UP/DOWN),  
   - количество принятых/отправленных пакетов, ошибки, коллизии,  
   - параметры MTU.  
   Примеры:  
   - `ifconfig eth1` — показывает подробную информацию по интерфейсу eth1.  
   - `ifconfig -a` — отображает все интерфейсы, включая отключённые.  
   - `ifconfig eth0 down` — отключает интерфейс.  
   - `ifconfig eth0 up` — включает интерфейс.

7. **Какую информацию можно получить, используя утилиту ping? Приведите примеры.**  
   `ping` используется для проверки доступности узла и качества сетевого соединения. Она показывает:  
   - время отклика (latency),  
   - потери пакетов,  
   - изменение задержки (jitter),  
   - IP-адрес цели.  
   Примеры:  
   - `ping 192.168.1.1` — проверка доступности локального шлюза.  
   - `ping -c 5 example.org` — отправка пяти пакетов.  
   - `ping -i 0.2 server.local` — интервал между пакетами 0.2 сек.  
   - `ping -s 1024 host` — отправка пакетов увеличенного размера.


# Заключение

В ходе работы была выполнена полная настройка DHCP-сервера Kea с поддержкой динамического обновления DNS-зон. Удалось сконфигурировать подсеть, диапазон выдаваемых адресов, сетевые опции и привязку сервера к нужному интерфейсу. После интеграции Kea с Bind9 через TSIG-ключи реализовано автоматическое добавление A- и PTR-записей при подключении клиентов к сети.  

Проверка с помощью утилиты dig показала, что клиент успешно получает IP-адрес и его доменное имя автоматически появляется в прямой DNS-зоне. Корректное формирование файла журнала зоны подтвердило работу механизма DDNS.  
